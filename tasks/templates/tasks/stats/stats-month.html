{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load group_check %}

{% block title %}Task manager | All Tasks{% endblock %}
{% block sidebar-content %}
    {% include 'partials/sidebar.html' %}
{% endblock sidebar-content %}
{% block background-image %}{% endblock background-image %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <h3 class="fw-bold text-primary mb-4">
                {% if month_number == '1' %} January {% elif month_number == '2' %} February
                {% elif month_number == '3' %} March {% elif month_number == '4' %} April
                {% elif month_number == '5' %} May {% elif month_number == '6' %} June
                {% elif month_number == '7' %} July {% elif month_number == '8' %} August
                {% elif month_number == '9' %} September {% elif month_number == '10' %} October
                {% elif month_number == '11' %} November {% elif month_number == '12' %} December
                {% endif %} {% now "Y" %}
            </h3>
        </div>
    </div>

    {% include 'tasks/stats/dropdowns.html' %}

    <div class="row">
        <div class="col-md-6">
            <div class="chart-card animate__animated animate__fadeInUp">
                <h5 class="card-title text-center">USD Overview</h5>
                <canvas id="myChartusd"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-card animate__animated animate__fadeInUp">
                <h5 class="card-title text-center">LBP Overview</h5>
                <canvas id="myChartlbp"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
{% block extra_js %} 
<script src="{% static 'js/chart.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("DOM fully loaded and parsed");

    // Get canvas elements
    const ctxUsd = document.getElementById('myChartusd');
    const ctxLbp = document.getElementById('myChartlbp');

    if (!ctxUsd) {
        console.error("Canvas with id 'myChartusd' not found");
    }
    if (!ctxLbp) {
        console.error("Canvas with id 'myChartlbp' not found");
    }

    // Extract data from template
    const usdLabels = [{% for stat in user_statsusd %}'{{ stat.user.username|escapejs }}',{% endfor %}];
    const usdData = [{% for stat in user_statsusd %}{{ stat.final_price|floatformat:2 }},{% endfor %}];
    const usdColors = [{% for color in usd_colors %}'{{ color }}',{% endfor %}];

    const lbpLabels = [{% for stat in user_statslbp %}'{{ stat.user.username|escapejs }}',{% endfor %}];
    const lbpData = [{% for stat in user_statslbp %}{{ stat.final_price|floatformat:2 }},{% endfor %}];
    const lbpColors = [{% for color in lbp_colors %}'{{ color }}',{% endfor %}];

    console.log("USD Labels:", usdLabels);
    console.log("USD Data:", usdData);
    console.log("USD Colors:", usdColors);

    console.log("LBP Labels:", lbpLabels);
    console.log("LBP Data:", lbpData);
    console.log("LBP Colors:", lbpColors);

    // Initialize USD chart
    if (ctxUsd) {
        try {
            const usdChart = new Chart(ctxUsd, {
                type: 'bar',
                data: {
                    labels: usdLabels,
                    datasets: [{
                        label: 'USD',
                        data: usdData,
                        backgroundColor: usdColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            console.log("USD Chart created successfully", usdChart);
        } catch (e) {
            console.error("Error creating USD chart:", e);
        }
    }

    // Initialize LBP chart
    if (ctxLbp) {
        try {
            const lbpChart = new Chart(ctxLbp, {
                type: 'bar',
                data: {
                    labels: lbpLabels,
                    datasets: [{
                        label: 'LBP',
                        data: lbpData,
                        backgroundColor: lbpColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            console.log("LBP Chart created successfully", lbpChart);
        } catch (e) {
            console.error("Error creating LBP chart:", e);
        }
    }
});
</script>

{% endblock extra_js %} 
                  