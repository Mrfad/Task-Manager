{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% load humanize %}
{% load group_check %}
{% load tz %}
{% block title %}Task manager | All Tasks{% endblock title %}

{% block sidebar-content %}
    {% include 'partials/sidebar.html' %}
{% endblock sidebar-content %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px !important;
        margin: 0 auto;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section h6 {
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

    /* Select2 with attached button styling */
    .select2-container--bootstrap-5 {
        flex-grow: 1;
    }
    
    .select2-container--bootstrap-5 .select2-selection {
        border-radius: 0.375rem 0 0 0.375rem !important;
        border-right: none !important;
        height: 38px;
    }
    
    .btn-icon {
        border-radius: 0 0.375rem 0.375rem 0 !important;
        height: 38px;
        width: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .action-bar {
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }

    @media (min-width: 768px) {
        .action-bar {
            position: sticky;
            bottom: 0;
            background: white;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-5 form-container">
    <div class="card border-0 shadow rounded-4">
        <div class="card-header bg-primary text-white rounded-top-4">
            <h5 class="mb-0"><i class="fa fa-folder-plus me-2"></i>Add New Project</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{% url 'tasks:add_project' %}" class="was-validated">
                {% csrf_token %}

                <!-- Project Details -->
                <div class="form-section">
                    <h6><i class="fa fa-info-circle me-1 text-secondary"></i>Project Details</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Project Name</label>
                            {% render_field project_form.name class="form-control" placeholder="Enter project name" %}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Budget / Balance</label>
                            {% render_field project_form.balance class="form-control" placeholder="e.g. 1000.00" %}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Currency</label>
                            {% render_field project_form.currency class="form-select" %}
                        </div>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="form-section">
                    <h6><i class="fa fa-user-tag me-1 text-secondary"></i>Customer</h6>
                    <div class="input-group">
                        <select name="customer" id="id_customer" class="form-select select2" required>
                            <option value="">Select or search for a customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.pk }}"
                                    {% if customer.pk|stringformat:"s" == selected_customer_id|stringformat:"s" %}selected{% endif %}>
                                    {{ customer.customer_name }} - {{ customer.customer_phone }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-secondary btn-icon" title="Add Customer" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="mt-2" id="customer-loading" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-section">
                    <h6><i class="fa fa-sticky-note me-1 text-secondary"></i>Notes</h6>
                    {% render_field project_form.notes class="form-control" rows="3" placeholder="Optional notes about the project" %}
                </div>

                <!-- Actions -->
                <div class="action-bar d-flex justify-content-between">
                    <a href="{% url 'tasks:all_tasks' %}" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left me-1"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fa fa-save me-1"></i> Save Project
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'customers/modals/add-customer-modal.html' %}
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function () {
    // Initialize Select2 with proper configuration
    $('#id_customer').select2({
        theme: 'bootstrap-5',
        placeholder: "Select or search for a customer...",
        allowClear: true,
        dropdownParent: $('.card-body'),
        minimumInputLength: 0 // Show dropdown without typing
    });

    // Ensure the field is marked as valid when a selection is made
    $('#id_customer').on('change', function() {
        if ($(this).val()) {
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });

    // Open dropdown when select is clicked
    $('#id_customer').on('click', function() {
        $(this).select2('open');
    });

    // Fix for Bootstrap 5 modal + Select2 issue
    $(document).on('select2:open', () => {
        document.querySelector('.select2-search__field').focus();
    });
});
</script>
{% endblock extra_js %}