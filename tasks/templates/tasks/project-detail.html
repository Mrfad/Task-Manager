{% extends 'base.html' %}
{#% load crispy_forms_tags %#}
{% load humanize %}
{% load group_check %}
{% load status_tags %}
{% load tz %}
{% block title %}Task manager | All Tasks{% endblock title %}

{% block background-image %}
{% endblock background-image %}

{% block sidebar-content %}
    {% include 'partials/sidebar.html' %}
{% endblock sidebar-content %}

{% block extra_css %}
<style>
    /* Custom back button styling */
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
    }
    .header-content {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-grow: 1;
    }
    .back-button {
        background-color: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 6px 12px 6px 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
    }
    .back-button:hover {
        background-color: rgba(255,255,255,0.3);
        transform: translateX(-3px);
        color: white;
        text-decoration: none;
    }
    .back-button i {
        margin-right: 6px;
        font-size: 0.9em;
    }
    .project-title {
        margin: 0;
        flex-grow: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

/* Fix Select2 dropdown z-index inside modal */
.select2-container {
    z-index: 1060 !important;
    width: 100% !important;
}
.select2-dropdown {
    z-index: 1061 !important;
}
.select2-container--default .select2-results>.select2-results__options
    {
        max-height: 400px !important;
        overflow-y: auto;
    }
    /* Fix Select2 dropdown inside modals */
    .select2-container {
        z-index: 1055 !important; /* above Bootstrap modal backdrop */
        width: 100% !important;
    }
    .select2-dropdown {
        z-index: 1056 !important;
    }
    .badge.bg-info-subtle { background-color: #d0ebff; }
    .badge.bg-success-subtle { background-color: #d3f9d8; }
    .badge.bg-danger-subtle { background-color: #ffe3e3; }
</style>
{% endblock extra_css %}

{% block content %}
    <!-- Project Summary Card -->
    <div class="card shadow-sm mt-4 border-0 rounded-4">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between rounded-top-4 px-4 py-3">
        <div class="d-flex align-items-center gap-3">
            <a href="{{ back_url }}" class="btn btn-light btn-sm shadow-sm">
                <i class="fas fa-arrow-left me-1"></i> Back
            </a>
            <h4 class="mb-0 fw-semibold">
                Project: {{ project.name }} <small class="text-white-50 ms-3">#{{ project.project_number }}</small>
            </h4>
        </div>
        <a href="#" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#assignTaskModal">
            <i class="fas fa-plus"></i> Assign Task
        </a>
    </div>
    <div class="card-body px-4 pt-3 pb-4">
        <div class="row gy-3">
            <div class="col-12 col-md-6">
                <strong>Customer:</strong> {{ project.customer.customer_name }}
            </div>
            <div class="col-12 col-md-6">
                <strong>Balance:</strong> {{ project.balance|floatformat:2|intcomma }} {{ project.currency }}
            </div>
            <div class="col-12 col-md-6">
                <strong>Spent:</strong> {{ project.spent|floatformat:2|intcomma }} {{ project.currency }}
            </div>
            <div class="col-12 col-md-6">
                <strong>Created At:</strong> {{ project.created_at|date:"M d, Y H:i" }}
            </div>
            <div class="col-12">
                <strong>Notes:</strong> {{ project.notes|default:"—" }}
            </div>
            <div class="col-12 col-md-4">
                <strong>Total Amount:</strong> 
                <span class="badge bg-info-subtle text-dark shadow-sm">{{ project.total_project_amount }}</span>
            </div>
            <div class="col-12 col-md-4">
                <strong>Paid Amount:</strong> 
                <span class="badge bg-success-subtle text-dark shadow-sm">{{ project.paid_project_amount }}</span>
            </div>
            <div class="col-12 col-md-4">
                <strong>Unpaid Amount:</strong> 
                <span class="badge bg-danger-subtle text-dark shadow-sm">{{ project.unpaid_project_amount }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mt-4 border-0 rounded-4">
    <div class="card-header bg-secondary text-white rounded-top-4 px-4 py-3">
        <h5 class="mb-0 fw-semibold">Related Tasks</h5>
    </div>
    <div class="card-body px-4 py-3">
        <div class="table-responsive-md">
            <table id="tasksTable" class="table table-hover table-bordered align-middle rounded-3">
                <thead class="table-light">
                    <tr>
                        <th>Order #</th>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Due Date</th>
                        <th>Paid Amount</th>
                        <th>Final Price</th>
                        <th>Currency</th>
                        <th>Paid</th>
                        <th>View</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.order_number|default:"—" }}</td>
                        <td>{{ task.task_name }}</td>
                        <td>
                            <span class="badge bg-{{ task.status|status_color }}">
                                {{ task.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if task.task_priority == "Urgent" %}
                                <span class="badge bg-danger">Urgent</span>
                            {% else %}
                                <span class="badge bg-info text-dark">Normal</span>
                            {% endif %}
                        </td>
                        <td>{{ task.job_due_date|date:"M d, Y" }}</td>
                        <td>
                            {% if task.payment_status and task.payment_status.paid_amount > 0 %}
                                <span class="badge bg-info-subtle text-dark">{{ task.payment_status.paid_amount|floatformat:2|intcomma }}</span>
                            {% else %}
                                <span class="text-muted">0.00</span>
                            {% endif %}
                        </td>
                        <td>{{ task.final_price|floatformat:2|intcomma }}</td>
                        <td>{{ task.currency }}</td>
                        <td>
                            {% if task.paid_status == "P" %}
                                <span class="badge bg-success">Paid</span>
                            {% elif task.paid_status == "O" %}
                                <span class="badge bg-warning text-dark">Overpaid</span>
                            {% else %}
                                <span class="badge bg-danger">Unpaid</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'tasks:task_detail' task.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                        <td>
                            <form method="POST" action="{% url 'tasks:remove_task_from_project' task.pk %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to remove this task from the project?');">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assign Task Modal -->
<div class="modal fade" id="assignTaskModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="assignTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <form method="POST" action="{% url 'tasks:assign_tasks_to_project' project.id %}">
        {% csrf_token %}
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-semibold" id="assignTaskModalLabel">
                <i class="fas fa-tasks me-2"></i> Assign Existing Tasks to Project
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <label for="taskSelect" class="form-label">Select Tasks</label>
            <select class="form-select" id="taskSelect" name="tasks" multiple="multiple" required>
                {% for task in tasks_with_no_project %}
                <option value="{{ task.id }}">{{ task.task_name.name }} - {{ task.order_number }} - {{task.customer_name.customer_name}} {{ task.customer_name.company }}</option>
                {% endfor %}
            </select>
            </div>
            <div class="modal-footer">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-paper-plane me-1"></i> Assign Selected
            </button>
            </div>
        </div>
        </form>
    </div>
  </div>
</div>


{% endblock content %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#tasksTable').DataTable({
            order: [[4, "asc"]],
            pageLength: 10
        });

        $('#taskSelect').select2({
            dropdownParent: $('#assignTaskModal'),  // Ensures dropdown stays inside modal
            width: '100%',
            placeholder: 'Search tasks...',
            allowClear: true
        });
    });
</script>
{% endblock extra_js %}