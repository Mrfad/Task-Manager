{% extends 'custom_email/base_email.html' %}
{% load crispy_forms_tags %}

{% block background-image %}{% endblock background-image %}
{% block title %}Send Email{% endblock %}

{% block email_content %}
  <h2 class="mb-4">Send Email</h2>

  <form method="post" novalidate enctype="multipart/form-data" id="emailForm">
    {% csrf_token %}
    <div class="card shadow-sm p-4">
      {{ form|crispy }}
      <div class="form-group">
        <small class="form-text text-muted">
          Separate multiple email addresses with commas (,) or semicolons (;)
        </small>
      </div>
      <div id="fileInfo" class="mb-2 text-muted small"></div>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Send Email</button>
      </div>
    </div>
  </form>

  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // File size validation
  document.addEventListener("DOMContentLoaded", function () {
    const attachmentInput = document.getElementById('id_attachments');
    const submitBtn = document.querySelector('button[type="submit"]');
    const fileInfo = document.getElementById('fileInfo');
    const EMAIL_MAX_SIZE = 10 * 1024 * 1024; // 10MB

    if (attachmentInput) {
      attachmentInput.addEventListener('change', function (e) {
        const files = e.target.files;
        let totalSize = 0;
        let fileList = '';
        let hasErrors = false;

        fileInfo.innerHTML = '';
        submitBtn.disabled = false;

        if (files.length > 0) {
          for (let file of files) {
            if (file.size > EMAIL_MAX_SIZE) {
              fileInfo.innerHTML = `
                <div class="text-danger">
                  File "${file.name}" exceeds 10MB limit (${(file.size / (1024 * 1024)).toFixed(2)}MB)
                </div>
              `;
              e.target.value = '';
              submitBtn.disabled = true;
              hasErrors = true;
              break;
            }
            totalSize += file.size;
            fileList += `${file.name} (${(file.size / (1024 * 1024)).toFixed(2)}MB)\n`;
          }

          if (!hasErrors) {
            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            fileInfo.innerHTML = `
              <strong>Selected ${files.length} file(s):</strong><br>
              <pre>${fileList}</pre>
              Total size: ${sizeMB} MB
            `;
            if (totalSize > EMAIL_MAX_SIZE) {
              fileInfo.innerHTML += `
                <div class="text-danger">
                  Total attachments exceed 10MB limit (${sizeMB}MB)
                </div>
              `;
              submitBtn.disabled = true;
            }
          }
        }
      });
    }
  });
</script>

<script>
  // Prevent double submission
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById('emailForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    form.addEventListener('submit', function () {
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Sending...';
    });
  });
</script>

<script>
  function initTagifyWithDynamicSuggestions(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;

    const tagify = new Tagify(input, {
      delimiters: ",|;",
      enforceWhitelist: false,
      dropdown: {
        enabled: 1,
        position: "text",
        maxItems: 10
      },
      originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(', ')
    });

    tagify.on('input', async (e) => {
      const value = e.detail.value;

      if (value.length < 2) return;  // Start searching after 2 chars

      try {
        const response = await fetch(`{% url 'mail:customer_email_suggestions' %}?q=${encodeURIComponent(value)}`);
        const data = await response.json();
        tagify.settings.whitelist = data;
        tagify.dropdown.show.call(tagify, value); // Show the updated list
      } catch (err) {
        console.error('Error loading suggestions:', err);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    initTagifyWithDynamicSuggestions('id_to_email');
    initTagifyWithDynamicSuggestions('id_cc');
    initTagifyWithDynamicSuggestions('id_bcc');
  });
</script>
<style>
  #fileInfo pre {
    margin: 5px 0;
    padding: 5px;
    background: #f8f9fa;
    border-radius: 3px;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
  }
  .text-danger {
    color: #dc3545;
    font-weight: bold;
  }
</style>
{% endblock extra_js %}
